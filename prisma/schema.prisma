generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String?
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  devices             Device[]
  conversationMembers ConversationMember[]
  messagesSent        Message[] @relation("messagesSent")
  userMessageStatus   UserMessageStatus[]
  MessageReadReceipt MessageReadReceipt[]
}

model Device {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id])
  userId     Int
  deviceId   String   @unique
  publicKey  String
  lastActive DateTime @updatedAt
  createdAt  DateTime @default(now())
  conversationKeys ConversationKey[]
}

model Conversation {
  id        Int      @id @default(autoincrement())
  type      String
  title     String?
  createdAt DateTime @default(now())
  members  ConversationMember[]
  messages Message[]
  keys     ConversationKey[]
}

model ConversationMember {
  id             Int          @id @default(autoincrement())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId Int
  user           User         @relation(fields: [userId], references: [id])
  userId         Int
  role           String
  joinedAt       DateTime  @default(now())
  lastReadMessageId Int?
  deletedAt    DateTime?

  @@unique([conversationId, userId])
}

model Message {
  id               Int          @id @default(autoincrement())
  conversation     Conversation @relation(fields: [conversationId], references: [id])
  conversationId   Int
  sender           User         @relation("messagesSent", fields: [senderId], references: [id])
  senderId         Int
  encryptedContent String
  encryptionType   String
  nonce            String
  createdAt        DateTime   @default(now())
  status           String
  readReceipts     MessageReadReceipt[]
  userStatus       UserMessageStatus[]
}

model MessageReadReceipt {
  id        Int      @id @default(autoincrement())
  message   Message  @relation(fields: [messageId], references: [id])
  messageId Int
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  readAt    DateTime @default(now())
  @@unique([messageId, userId])
}

model UserMessageStatus {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  message   Message  @relation(fields: [messageId], references: [id])
  messageId Int
  deleted   Boolean  @default(false)
  @@unique([userId, messageId])
}

model ConversationKey {
  id             Int          @id @default(autoincrement())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId Int
  device         Device       @relation(fields: [deviceId], references: [id])
  deviceId       Int
  encryptedKey   String
  @@unique([conversationId, deviceId])
}
